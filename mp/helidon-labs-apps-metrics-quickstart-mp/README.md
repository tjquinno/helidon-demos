# Helidon MP General Metrics Example

This example results from using `helidon init` to create a Helidon MP QuickStart example app, then applying a few simple changes to illustrate various aspects of metrics.

You can recreate the example by following the steps described below.

Note that an optional step shows an incubating feature in Helidon 4.x which includes Helidon-provided meters for virtual threads. To experiment with that feature you need Java 24 or later, so download and install JDK 24 now if you want to try that feature.
## Prerequisites
1. Download the Helidon CLI if you do not already have it. See the [CLI doc page](https://helidon.io/docs/v4/about/cli) for complete information.

   MacOS
   ```shell
   curl -L -O https://helidon.io/cli/latest/darwin/helidon
   chmod +x ./helidon
   sudo mv ./helidon /usr/local/bin/
   ```
2. If you want to use the incubating virtual threads metrics you need to download JDK 24 or later.  See the [Java downloads page](https://www.oracle.com/java/technologies/downloads/).
3. To use the Prometheus back-end and UI to browse metrics, [download Prometheus](https://prometheus.io/download/). The `prometheus.yml` config file in this project contains settings to retrieve metrics from the SE and MP variants of this application.

## Create the project
1. Copy the `.helidon` file from this project into a local directory on your system.
2. Create the example project using that file's settings with the following command.
   ```shell
   helidon init --props-file path-to-the-copied-.helidon-file
   ```
   This is equivalent to invoking `helidon init --version 4.3.1` and specifying:
    * `Helidon MP` for the flavor
    * `Quickstart` for the application type
    * `io.helidon.labs.apps` as the Maven `groupId`
    * `helidon-labs-apps-metrics-quickstart-mp` as the Maven `artifactId`
    * `io.helidon.labs.apps.metrics.quickstart.mp` as the package
    * defaults for other prompts

## Build and run the initial project (before any changes)
1. In a command window:
   ```shell
   mvn clean package
   java -jar target/helidon-labs-apps-metrics-quickstart-mp.jar
   ```
2. In another command window run the following commands:
   ```shell
   curl http://localhost:8080/greet
   curl http://localhost:8080/metrics | grep requests_count
   ```
   The first `curl` displays `{"message":"Hello World!"}`. The second displays the following output:
   ```list
   # HELP requests_count_total Each request (regardless of HTTP method) will increase this counter
   # TYPE requests_count_total counter
   requests_count_total{scope="vendor",} 2.0
   ```
   The Helidon-provided count is 2 because even requests to the `/metrics` or other built-in Helidon endpoints contribute to the requests count.

   Run one more command:
   ```shell
   curl http://localhost:8080/metrics
   ```
   The output includes numerous built-in Helidon system meters describing JVM behavior, including class loading data, GC, etc. The `pom.xml` file generated by `helidon init` contains a dependency on `io.helidon.metrics:helidon-metrics-system-meters` which provides these meters.

## Add the registration and use of a custom timer
Next, add a custom `Timer` to measure the time spent processing `GET` requests.

1. Chdeck dependencies on the Helidon MP metrics and the MicroProfile metrics artifacts.

   Make sure the following dependencies appear in the `pom.xml` file:
   ```xml
   <dependency>
       <groupId>io.helidon.metrics</groupId>
       <artifactId>helidon-metrics-api</artifactId>
   </dependency>
   <dependency>
       <groupId>org.eclipse.microprofile.metrics</groupId>
        <artifactId>microprofile-metrics-api</artifactId>
   </dependency>
   ```
   The project generated from `helidon init` should already contain these dependencies. 
2. Add annotations to time the "get" methods.

   In the `GreetService.java` file add the following annotation to two methods:
   * `getDefaultMessage`
   * `getMessage`
   ```java
   @Timed(absolute = true, name = "mpGets")
   ```
   By default, metric names derived from annotations include the class and method name on which the annotation appears. Setting `absolute = true` allows you to specify exactly the name you want metrics to use without qualification with the class and method name.

3. Stop, rebuild, and rerun the application.
    1. Stop the earlier run of the application if you have not already.
    2. Run the following commands in the original terminal window.
   ```shell
   maven clean package
   java -jar target/helidon-labs-apps-metrics-quickstart-mp.jar
   ```
    4. Access the app and retrieve metrics, inspecting the output for the new custom timer just added.
        1. Run the following commands:
           ```shell
           curl http://localhost:8080/greet
           curl http://localhost:8080/metrics | grep mpGets
           ```
        2. Note the several lines of output for the new `allGets` timer (naturally, your values might be different):
            ```list
            # HELP mpGets_seconds  
            # TYPE mpGets_seconds summary
            mpGets_seconds{mp_scope="application",quantile="0.5",} 2.56E-5
            mpGets_seconds{mp_scope="application",quantile="0.75",} 2.8672E-5
            mpGets_seconds{mp_scope="application",quantile="0.95",} 2.8672E-5
            mpGets_seconds{mp_scope="application",quantile="0.98",} 2.8672E-5
            mpGets_seconds{mp_scope="application",quantile="0.99",} 2.8672E-5
            mpGets_seconds{mp_scope="application",quantile="0.999",} 2.8672E-5
            mpGets_seconds_count{mp_scope="application",} 4.0
            mpGets_seconds_sum{mp_scope="application",} 4.59959E-4
            # HELP mpGets_seconds_max
            # TYPE mpGets_seconds_max gauge
            mpGets_seconds_max{mp_scope="application",} 2.925E-5  
            ```
        3. Wait a few minutes, then retrieve metrics again.
           ```shell
           curl http://localhost:8080/metrics | grep mpGets
           ```
           ```list
           # HELP mpGets_seconds  
           # TYPE mpGets_seconds summary
           mpGets_seconds{mp_scope="application",quantile="0.5",} 0.0
           mpGets_seconds{mp_scope="application",quantile="0.75",} 0.0
           mpGets_seconds{mp_scope="application",quantile="0.95",} 0.0
           mpGets_seconds{mp_scope="application",quantile="0.98",} 0.0
           mpGets_seconds{mp_scope="application",quantile="0.99",} 0.0
           mpGets_seconds{mp_scope="application",quantile="0.999",} 0.0
           mpGets_seconds_count{mp_scope="application",} 4.0
           mpGets_seconds_sum{mp_scope="application",} 4.59959E-4
           # HELP mpGets_seconds_max
           # TYPE mpGets_seconds_max gauge
           mpGets_seconds_max{mp_scope="application",} 0.0
           ```
           Note that the `count` and `sum` still reflect the earlier access to the `/greet` endpoint, but the other statistics are zero. These value shows the time-window behavior of distribution summaries; Micrometer clears those values if no updates are applied to the meter in a certain period of time. See the discussion of the time window in the Micrometer [`Timer`](https://docs.micrometer.io/micrometer/reference/concepts/timers.html) documentation.

## Use Prometheus to view metrics
The Prometheus server is one of several backends which can retrieve metrics from a server and allow you to query and display them.

In a terminal window, `cd` to this project's top-level directory and start Prometheus wherever you downloaded it to.

```shell
cd this-project-directory
./path-to-prometheus/prometheus
```

Prometheus reads the `prometheus.yml` file from the current directory.

Use a browser to navigate to `localhost:9090`.

1. View the status of the scraped applications.

   Click on the "Status" drop-list at the top of the page and click on "Target health." The status page shows both the SE and MP demo apps. At least one should be running and displayed in green.
2. Click the "Prometheus" link in the upper left to return to the main query page.
3. Click on the "Graph" tab.
4. Click in the "Enter expression" field near the top and enter "mp". The UI displays matching meter names. Click on "mpGets_seconds_sum" and then the "Execute" button to the right to graph the accumulated total time spent responding to get requests.
5. In the query field change the meter name to "mpGets_seconds" and click "Execute." The UI shows multiple lines, color-coded to each of the percentiles listed at the bottom of the UI.

   If you wait a moment, then click "Execute" again, you will see the values drop to zero, illustrating the time window behavior of distribution summaries (histograms).
6. In the query field change the meter name to "REST". The UI displays the automatic timers for all REST endpoints. Choose `REST_request_seconds` and click "Execute." Notice that each timer listed at the bottom of the UI has `class` and `method` tags to distinguish the several endpoint timers.
7. In the query field add `{` to the end of the expression. The UI displays tag names. Enter `class` and the UI filters. Select the line with `GreetResource`, and the UI graphs only the data for the `GreetResource` timers.

